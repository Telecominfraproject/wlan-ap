From d9a9b24609b42519e7ebc7458fbdcd08ced7e9e2 Mon Sep 17 00:00:00 2001
From: John Crispin <john@phrozen.org>
Date: Tue, 5 Aug 2025 16:58:08 +0200
Subject: [PATCH] mediatek: add kernel-6.6 support

Signed-off-by: John Crispin <john@phrozen.org>
---
 include/kernel-6.6                                 | 2 ++
 include/target.mk                                  | 2 +-
 package/boot/uboot-envtools/files/mediatek_filogic | 5 +++++
 package/kernel/linux/modules/netdevices.mk         | 2 +-
 package/kernel/linux/modules/netsupport.mk         | 2 +-
 5 files changed, 10 insertions(+), 3 deletions(-)
 create mode 100644 include/kernel-6.6

diff --git a/include/kernel-6.6 b/include/kernel-6.6
new file mode 100644
index 0000000000..f3ca0941dd
--- /dev/null
+++ b/include/kernel-6.6
@@ -0,0 +1,2 @@
+LINUX_VERSION-6.6 = .89
+LINUX_KERNEL_HASH-6.6.89 = c21af7d36068e4ac0704c242eac8459212e6bf4a5d09df941b9b4d17dc1eba00
diff --git a/include/target.mk b/include/target.mk
index 3a17587e4e..a6a00c2c40 100644
--- a/include/target.mk
+++ b/include/target.mk
@@ -169,7 +169,7 @@ ifneq ($(TARGET_BUILD)$(if $(DUMP),,1),)
   include $(INCLUDE_DIR)/kernel-version.mk
 endif
 
-GENERIC_PLATFORM_DIR := $(TOPDIR)/target/linux/generic
+GENERIC_PLATFORM_DIR := $(firstword $(wildcard $(TOPDIR)/target/linux/feeds/$(BOARD)/../linux/generic $(TOPDIR)/target/linux/generic))
 ifeq ($(CONFIG_TARGET_ipq95xx),y)
 GENERIC_BACKPORT_DIR :=
 GENERIC_PATCH_DIR :=
diff --git a/package/boot/uboot-envtools/files/mediatek_filogic b/package/boot/uboot-envtools/files/mediatek_filogic
index f13beed526..77bc168d03 100644
--- a/package/boot/uboot-envtools/files/mediatek_filogic
+++ b/package/boot/uboot-envtools/files/mediatek_filogic
@@ -12,6 +12,11 @@ touch /etc/config/ubootenv
 board=$(board_name)
 
 case "$board" in
+edgecore,eap111|\
+edgecore,eap112)
+	local envdev=/dev/mtd$(find_mtd_index "u-boot-env")
+        ubootenv_add_uci_config "$envdev" "0x0" "0x20000" "0x20000"
+        ;;
 bananapi,bpi-r3)
 	rootdev="$(cmdline_get_var root)"
 	rootdev="${rootdev##*/}"
diff --git a/package/kernel/linux/modules/netdevices.mk b/package/kernel/linux/modules/netdevices.mk
index 1905e79a4f..b9d4c6046a 100644
--- a/package/kernel/linux/modules/netdevices.mk
+++ b/package/kernel/linux/modules/netdevices.mk
@@ -379,7 +379,7 @@ define KernelPackage/phy-aquantia
   TITLE:=Aquantia Ethernet PHYs
   DEPENDS:=+kmod-libphy +kmod-hwmon-core
   KCONFIG:=CONFIG_AQUANTIA_PHY
-  FILES:=$(LINUX_DIR)/drivers/net/phy/aquantia.ko
+  FILES:=$(LINUX_DIR)/drivers/net/phy/aquantia.ko@lt6.0
   AUTOLOAD:=$(call AutoLoad,18,aquantia,1)
 endef
 
diff --git a/package/kernel/linux/modules/netsupport.mk b/package/kernel/linux/modules/netsupport.mk
index f54a5014b8..129fc42f48 100644
--- a/package/kernel/linux/modules/netsupport.mk
+++ b/package/kernel/linux/modules/netsupport.mk
@@ -994,7 +994,7 @@ endef
 $(eval $(call KernelPackage,bpf-test))
 
 
-SCHED_MODULES_EXTRA = sch_codel sch_dsmark@gt5.4 sch_gred sch_multiq sch_sfq sch_teql sch_fq act_pedit act_simple act_csum em_cmp em_nbyte em_meta em_text
+SCHED_MODULES_EXTRA = sch_codel sch_gred sch_multiq sch_sfq sch_teql sch_fq act_pedit act_simple act_csum em_cmp em_nbyte em_meta em_text
 SCHED_FILES_EXTRA = $(foreach mod,$(SCHED_MODULES_EXTRA),$(LINUX_DIR)/net/sched/$(mod).ko)
 
 define KernelPackage/sched
-- 
2.34.1

