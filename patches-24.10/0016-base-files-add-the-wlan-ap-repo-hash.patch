From 15334aa1b2e55d5969370448a29e53b65e6abf58 Mon Sep 17 00:00:00 2001
From: John Crispin <john@phrozen.org>
Date: Fri, 1 Aug 2025 07:40:38 +0200
Subject: [PATCH 16/55] base-files: add the wlan-ap repo hash

currently the banner will show the revision of the build tree.
This patch adds the hash of the wlan-ap tree.

Signed-off-by: John Crispin <john@phrozen.org>
---
 include/version.mk                            |  7 ++++++
 package/base-files/Makefile                   |  2 ++
 package/base-files/files/etc/banner           |  1 +
 package/base-files/files/etc/openwrt_release  |  2 ++
 package/base-files/files/etc/openwrt_version  |  1 +
 package/base-files/files/usr/lib/os-release   |  2 ++
 ...p-revision-info-to-system.board-call.patch | 23 +++++++++++++++++++
 scripts/getver.sh                             | 12 ++++++++++
 8 files changed, 50 insertions(+)
 create mode 100644 package/system/procd/patches/0001-procd-add-tip-revision-info-to-system.board-call.patch

diff --git a/include/version.mk b/include/version.mk
index a6ebe58779..3712e844c8 100644
--- a/include/version.mk
+++ b/include/version.mk
@@ -56,6 +56,11 @@ VERSION_PRODUCT:=$(if $(VERSION_PRODUCT),$(VERSION_PRODUCT),Generic)
 VERSION_HWREV:=$(call qstrip,$(CONFIG_VERSION_HWREV))
 VERSION_HWREV:=$(if $(VERSION_HWREV),$(VERSION_HWREV),v0)
 
+VERSION_TIP:=$(shell $(TOPDIR)/scripts/getver.sh wlan-ap)
+
+VERSION_TIP_VERSION:=$(shell $(TOPDIR)/scripts/getver.sh wlan-ap-version)
+VERSION_TIP_VERSION:=$(if $(VERSION_TIP_VERSION),$(VERSION_TIP_VERSION),devel)
+
 define taint2sym
 $(CONFIG_$(firstword $(subst :, ,$(subst +,,$(subst -,,$(1))))))
 endef
@@ -105,5 +110,7 @@ VERSION_SED_SCRIPT:=$(SED) 's,%U,$(call sed_escape,$(VERSION_REPO)),g' \
 	-e 's,%s,$(call sed_escape,$(VERSION_SUPPORT_URL)),g' \
 	-e 's,%P,$(call sed_escape,$(VERSION_PRODUCT)),g' \
 	-e 's,%h,$(call sed_escape,$(VERSION_HWREV)),g' \
+	-e 's,%a,$(call sed_escape,$(VERSION_TIP)),g' \
+	-e 's,%x,$(call sed_escape,$(VERSION_TIP_VERSION)),g' \
 	-e 's,%B,$(call sed_escape,$(SOURCE_DATE_EPOCH)),g'
 
diff --git a/package/base-files/Makefile b/package/base-files/Makefile
index c78c073699..b5f1d44ae1 100644
--- a/package/base-files/Makefile
+++ b/package/base-files/Makefile
@@ -249,6 +249,8 @@ endif
 	$(if $(CONFIG_TARGET_PREINIT_DISABLE_FAILSAFE), \
 		rm -f $(1)/etc/banner.failsafe,)
 
+	$(CP) $(1)/etc/openwrt_release $(TOPDIR)/tmp/
+
 ifneq ($(CONFIG_USE_APK),)
 	mkdir -p $(1)/etc/apk/
 	$(call FeedSourcesAppendAPK,$(1)/etc/apk/repositories)
diff --git a/package/base-files/files/etc/banner b/package/base-files/files/etc/banner
index f73423bad4..65c175e1ef 100644
--- a/package/base-files/files/etc/banner
+++ b/package/base-files/files/etc/banner
@@ -4,5 +4,6 @@
  |_______||   __|_____|__|__||________|__|__|   |__|
           |__| W I R E L E S S   F R E E D O M
  ---------------------------------------------------
+ ApNos-%a-%x
  %D %V, %C
  ---------------------------------------------------
diff --git a/package/base-files/files/etc/openwrt_release b/package/base-files/files/etc/openwrt_release
index d03400ca05..3652b1a49a 100644
--- a/package/base-files/files/etc/openwrt_release
+++ b/package/base-files/files/etc/openwrt_release
@@ -5,3 +5,5 @@ DISTRIB_TARGET='%S'
 DISTRIB_ARCH='%A'
 DISTRIB_DESCRIPTION='%D %V %C'
 DISTRIB_TAINTS='%t'
+DISTRIB_TIP='%D %V %C / TIP-%x-%a'
+DISTRIB_TIP_VERSION='%x'
diff --git a/package/base-files/files/etc/openwrt_version b/package/base-files/files/etc/openwrt_version
index 48157ed97f..bb0ef233ac 100644
--- a/package/base-files/files/etc/openwrt_version
+++ b/package/base-files/files/etc/openwrt_version
@@ -1 +1,2 @@
+ApNos-%a
 %C
diff --git a/package/base-files/files/usr/lib/os-release b/package/base-files/files/usr/lib/os-release
index 12db2c0ac6..d8baf63a9c 100644
--- a/package/base-files/files/usr/lib/os-release
+++ b/package/base-files/files/usr/lib/os-release
@@ -17,3 +17,5 @@ OPENWRT_DEVICE_PRODUCT="%P"
 OPENWRT_DEVICE_REVISION="%h"
 OPENWRT_RELEASE="%D %V %C"
 OPENWRT_BUILD_DATE="%B"
+DISTRIB_TIP='%D %V %C / TIP-%x-%a'
+DISTRIB_TIP_VERSION='%x'
diff --git a/package/system/procd/patches/0001-procd-add-tip-revision-info-to-system.board-call.patch b/package/system/procd/patches/0001-procd-add-tip-revision-info-to-system.board-call.patch
new file mode 100644
index 0000000000..6fcfa80f37
--- /dev/null
+++ b/package/system/procd/patches/0001-procd-add-tip-revision-info-to-system.board-call.patch
@@ -0,0 +1,23 @@
+From b08e6ce0ebf0cd5aa7a6ed463a83160634ad9693 Mon Sep 17 00:00:00 2001
+From: John Crispin <john@phrozen.org>
+Date: Tue, 4 May 2021 10:37:41 +0200
+Subject: [PATCH] procd: add tip revision info to system.board call
+
+Signed-off-by: John Crispin <john@phrozen.org>
+---
+ system.c | 4 ++++
+ 1 file changed, 4 insertions(+)
+
+--- a/system.c
++++ b/system.c
+@@ -281,6 +281,10 @@ static int system_board(struct ubus_cont
+ 				key = "description";
+ 			else if (!strcasecmp(key, "OPENWRT_BUILD_DATE"))
+ 				key = "builddate";
++			else if (!strcasecmp(key, "DISTRIB_TIP"))
++				key = "tip-revision";
++			else if (!strcasecmp(key, "DISTRIB_TIP_VERSION"))
++				key = "tip-version";
+ 			else
+ 				continue;
+ 
diff --git a/scripts/getver.sh b/scripts/getver.sh
index 0659d8004a..c9ae38b91b 100755
--- a/scripts/getver.sh
+++ b/scripts/getver.sh
@@ -3,6 +3,18 @@ export LANG=C
 export LC_ALL=C
 [ -n "$TOPDIR" ] && cd $TOPDIR
 
+[ "$1" = "wlan-ap" ] && {
+	cd ..
+	git log -n 1 --format="%h"
+	exit 0
+}
+
+[ "$1" = "wlan-ap-version" ] && {
+	cd ..
+	git tag --points-at HEAD
+	exit 0
+}
+
 GET_REV=$1
 
 try_version() {
-- 
2.34.1

