From 8785f5d3ed881ee0eb6691332566a47c12e6d57a Mon Sep 17 00:00:00 2001
From: Sivashankari Madhavan <quic_sivamadh@quicinc.com>
Date: Tue, 13 Sep 2022 17:08:08 +0530
Subject: [PATCH] mac80211: Fix Green AP Crash issue

While execute the Green AP set command, filling the bss info changed flags
for AP_PS based on hw_param supports_ap_ps. In ath11k, supports_ap_ps is
not enabled. Due to this not filling the bss changed flags for AP_PS,
and processing the default BSS changed value -EINVAL (-22). Based on
this value some unexpected BSS_CHANGED Flags getting processed and
crash issue observed.

Added the pre-condition checking. If the err is less than of 0, then avoided
to update the BSS info changed Value.

Signed-off-by: Sivashankari Madhavan <quic_sivamadh@quicinc.com>
---
 net/mac80211/cfg.c | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/net/mac80211/cfg.c b/net/mac80211/cfg.c
index bfbe75e..410772d 100644
--- a/net/mac80211/cfg.c
+++ b/net/mac80211/cfg.c
@@ -1472,7 +1472,7 @@ static int ieee80211_update_ap(struct wiphy *wiphy, struct net_device *dev,
 	struct ieee80211_sub_if_data *sdata;
 	struct beacon_data *old;
 	int err = -EINVAL;
-	u32 changed;
+	u32 changed = 0;
 
 	sdata = IEEE80211_DEV_TO_SUB_IF(dev);
 	sdata_assert_lock(sdata);
@@ -1501,8 +1501,10 @@ static int ieee80211_update_ap(struct wiphy *wiphy, struct net_device *dev,
 		else
 			err |= BSS_CHANGED_PS;
 	}
+	
+	if (err > 0)
+		changed = err;
 
-	changed = err;
 	if (params->fils_discovery.max_interval) {
 		err = ieee80211_set_fils_discovery(sdata,
 						   &params->fils_discovery);
-- 
2.17.1

